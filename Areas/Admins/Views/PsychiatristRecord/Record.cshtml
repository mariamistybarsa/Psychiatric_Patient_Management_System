@model IEnumerable<Psychiatrist_Management_System.Models.PsychiatristRecords>

<div class="container mt-4">
    <div class="row mb-4 align-items-end">
        <div class="col-md-6">
            <h3 class="fw-bold text-dark">Psychiatrist Records Report</h3>
        </div>

        <form method="get" asp-action="Record" class="row g-2">
            <div class="col-md-4">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" name="StartDate"
                       value="@(ViewBag.StartDate != null ? ((DateTime)ViewBag.StartDate).ToString("yyyy-MM-dd") : "")" />
            </div>
            <div class="col-md-4">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control"
                       min="@(ViewBag.StartDate != null ? ((DateTime)ViewBag.StartDate).ToString("yyyy-MM-dd") : "")"
                       name="EndDate"
                       value="@(ViewBag.EndDate != null ? ((DateTime)ViewBag.EndDate).ToString("yyyy-MM-dd") : "")" />
            </div>
            <div class="col-md-4 d-flex">
                <button type="submit" class="btn btn-dark align-self-end w-100">Submit</button>
            </div>
        </form>
    </div>

    @if (Model != null && Model.Any())
    {
        var groupedRecords = Model
        .GroupBy(r => new { r.PsychiatristId, r.PsychiatristName })
        .Select(g => new
        {
            PsychiatristId = g.Key.PsychiatristId,
            PsychiatristName = g.Key.PsychiatristName,
            TotalRecords = g.Sum(x => x.Records)
        });
            <table id="designationTable" class="w-100" style="border-collapse: collapse; margin-top:20px;">
            <thead>
                <tr>
                    <th style="border:1px solid #000; padding:6px; text-align:left;">Psychiatrist</th>
                    <th style="border:1px solid #000; padding:6px; text-align:left;">Total Booking</th>
                    <th style="border:1px solid #000; padding:6px; text-align:left;">Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in groupedRecords)
                {
                    <tr>
                        <td style="border:1px solid #000; padding:6px;">@item.PsychiatristName</td>
                        <td style="border:1px solid #000; padding:6px;">@item.TotalRecords</td>
                        <td style="border:1px solid #000; padding:6px;">
                            <a class="btn btn-sm btn-outline-dark"
                               asp-controller="PsychiatristRecord"
                               asp-action="Details"
                               asp-route-psychiatristId="@item.PsychiatristId">
                                View Report
                            </a>

                        </td>
                    </tr>
                }

            </tbody>
        </table>

        <div class="d-flex justify-content-end mb-3 mt-3">
            <button id="downloadPdf" class="btn btn-dark">
                <i class="bi bi-download"></i> Download PDF
            </button>
        </div>
    }
    else
    {
        <div class="alert alert-secondary text-center">
            No records found.
        </div>
    }
</div>
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        $(document).ready(function () {
            $('#designationTable').DataTable(); // Different ID
        });
    
   
        $(document).ready(function () {
            // Initialize DataTable
            $('#designationTable').DataTable();

            // Download PDF
            $('#downloadPdf').click(function () {
                const { jsPDF } = window.jspdf;
                var doc = new jsPDF('p', 'pt', 'a4');

                html2canvas(document.querySelector("#designationTable")).then(canvas => {
                    var imgData = canvas.toDataURL("image/png");
                    var imgProps = doc.getImageProperties(imgData);

                    var pdfWidth = doc.internal.pageSize.getWidth();
                    var pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    doc.addImage(imgData, "PNG", 10, 10, pdfWidth - 20, pdfHeight);
                    doc.save("Psychiatrist_Records_Report.pdf");
                });
            });
        });
    </script>
}

