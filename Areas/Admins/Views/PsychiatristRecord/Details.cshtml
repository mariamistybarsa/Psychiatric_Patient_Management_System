@model IEnumerable<Psychiatrist_Management_System.Models.PsychiatristRecords>

<div class="container mt-4">
    <h3>@ViewBag.PsychiatristName - Booking Details</h3>

    <!-- Date Range Filter -->
    <form method="get" asp-action="Details" class="row g-2 mb-3">
        <input type="hidden" name="psychiatristId" value="@ViewBag.PsychiatristId" />
        <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" name="startDate"
                   value="@(ViewBag.StartDate != null ? ((DateTime)ViewBag.StartDate).ToString("yyyy-MM-dd") : "")" />
        </div>
        <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" name="endDate"
                   value="@(ViewBag.EndDate != null ? ((DateTime)ViewBag.EndDate).ToString("yyyy-MM-dd") : "")" />
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-dark w-100">Search</button>
        </div>
    </form>

    @if (Model != null && Model.Any())
    {
        <table class="table table-bordered mt-3">
            <thead>
                <tr>
                    <th>Booking Id</th>

                    <th>Appointment Date</th>
                    <th>Appointment Time</th>
                    <th>Status</th>
                    <th>Approved At</th>
                    <th>Cancelled At</th>
                    <th>Cancel Reason</th>
                    <th>Completed At</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.BookingId</td>
                        <td>@item.AppointmentDate.ToString("yyyy-MM-dd")</td>
                        <td>@item.AppointmentTime</td>
                        <td>@item.ApprovalStatus</td>
                        <td>@(item.ApprovedAt?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                        <td>@(item.CancelledAt?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                        <td>@item.CancelReason</td>
                        <td>@(item.CompletedAt?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                        <td>@item.Notes</td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="mb-3">
            <button class="btn btn-danger" onclick="downloadPDF()">Download PDF</button>
        </div>
    }
    else
    {
        <div class="alert alert-secondary text-center">No booking records found.</div>
        <div class="mb-3">
            <button class="btn btn-danger" onclick="downloadPDF()">Download PDF</button>
        </div>
}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            const element = document.getElementById('table-container');

            html2canvas(element, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 595.28; // A4 width in pt
                const pageHeight = 841.89; // A4 height in pt
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save('booking-details.pdf');
            });
        }
    </script>
